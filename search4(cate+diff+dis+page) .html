<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GASæ­·å±†è¤‡ç¿’è€ƒè©¦é¡ŒæŸ¥è©¢</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <style>
        /* æ•´é«”èƒŒæ™¯èˆ‡å­—é«” */
        body { 
            font-family: "Microsoft JhengHei", Arial, sans-serif; 
            background-color: #f4f4f4; 
            text-align: center; 
            padding-bottom: 50px; 
            font-size: 18px; /* æå‡åŸºç¤å­—é«” */
        }
        
        h1 { color: #333; margin-bottom: 20px; font-size: 28px; }

        /* æœå°‹èˆ‡é¸å–®å€å¡Š */
        .search-container { 
            margin-bottom: 25px; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            gap: 15px; 
        }
        #myInput {
            width: 40%; font-size: 20px; padding: 12px;
            border-radius: 10px; border: 2px solid #007BFF;
        }
        #rowsPerPageSelect { 
            padding: 10px; 
            font-size: 18px; 
            border-radius: 10px; 
            border: 2px solid #007BFF; 
        }

        /* è¡¨æ ¼æ¨£å¼å„ªåŒ– */
        table {
            margin: 0 auto; border-collapse: collapse; width: 95%;
            background: white; border-radius: 8px; overflow: hidden;
            box-shadow: 0px 0px 15px rgba(0, 0, 0, 0.1);
        }
        #myTable th { 
            background-color: #007BFF; 
            color: white; 
            padding: 15px 10px;
            font-size: 20px; 
        }
        #myTable td { 
            padding: 15px 10px; 
            border-bottom: 1px solid #ddd; 
            font-size: 20px; /* è¡¨æ ¼å…§å®¹å­—é«”æ”¾å¤§ */
            line-height: 1.5;
        }
        #myTable tr:hover { background-color: #f9f9f9; }

        /* æŒ‰éˆ•æ¨£å¼ */
        button { 
            padding: 10px 16px; 
            font-size: 18px; /* æŒ‰éˆ•å­—é«”æ”¾å¤§ */
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            transition: 0.3s; 
        }
        .edit-btn { background-color: #ffc107; color: black; margin-bottom: 5px; }
        .delete-btn { background-color: #dc3545; color: white; }
        .add-btn { background-color: #28a745; color: white; margin: 10px; font-weight: bold; }

        /* å½ˆå‡ºè¡¨å–®æ”¾å¤§ */
        #dataForm {
            display: none; position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%); background: white;
            padding: 30px; box-shadow: 0px 0px 30px rgba(0,0,0,0.5);
            border-radius: 12px; z-index: 1000;
            width: 80%; max-width: 800px;
        }
        #dataForm h2 { font-size: 24px; margin-top: 0; }
        #dataForm td { font-size: 18px; padding: 8px; }
        #dataForm input { 
            width: 100%; 
            padding: 10px; 
            font-size: 18px; 
            border: 1px solid #ccc; 
            border-radius: 5px;
        }

        /* åˆ†é æ§åˆ¶å€ */
        .pagination { 
            margin: 30px 0; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            gap: 20px; 
        }
        .page-btn { 
            background-color: #007BFF; 
            color: white; 
            padding: 12px 24px; 
            font-size: 18px; 
        }
        #pageInfo { font-size: 20px; font-weight: bold; }
    </style>
</head>
<body>

    <h1>æ­·å±†è¤‡ç¿’è€ƒè©¦é¡Œåˆ—è¡¨</h1>

    <div class="search-container">
        <input type="text" id="myInput" placeholder="ğŸ” è¼¸å…¥é—œéµå­—æœå°‹...">
        <select id="rowsPerPageSelect">
            <option value="10">æ¯é  10 ç­†</option>
            <option value="20">æ¯é  20 ç­†</option>
            <option value="50">æ¯é  50 ç­†</option>
        </select>
        <button class="add-btn" onclick="addNew()">â• æ–°å¢è³‡æ–™</button>
    </div>

    <div id="dataForm">
        <h2 id="formTitle">ğŸ“Œ ç·¨è¼¯è³‡æ–™</h2>
        <input type="hidden" id="rowIndex">
        <table>
            <tr><td>å¹´åº¦: <input type="text" id="year"></td><td>æ¬¡åˆ¥: <input type="text" id="term"></td></tr>
            <tr><td>å‡ºç‰ˆç¤¾: <input type="text" id="publisher"></td><td>é¡Œè™Ÿ: <input type="text" id="question"></td></tr>
            <tr><td>å†Šåˆ¥å–®å…ƒ: <input type="text" id="unit"></td><td>æ¸¬é©—å…§å®¹: <input type="text" id="content"></td></tr>
            <tr><td>ç­”æ¡ˆ: <input type="text" id="answer"></td><td>é¡åˆ¥: <input type="text" id="category"></td></tr>
            <tr><td>é›£åº¦: <input type="text" id="difficult"></td><td>é‘‘åˆ¥åº¦: <input type="text" id="discrimination"></td></tr>
        </table>
        <div style="margin-top:10px;">
            <button id="saveBtn" class="add-btn" onclick="saveData()">ğŸ’¾ å„²å­˜</button>
            <button class="delete-btn" onclick="hideForm()">âŒ é—œé–‰</button>
        </div>
    </div>

    <table id="myTable">
        <thead>
            <tr>
                <th>å¹´åº¦</th><th>æ¬¡åˆ¥</th><th>å‡ºç‰ˆç¤¾</th><th>é¡Œè™Ÿ</th><th>å†Šåˆ¥åŠå–®å…ƒ</th><th>æ¸¬é©—å…§å®¹</th><th>ç­”æ¡ˆ</th><th>é¡åˆ¥</th><th>é›£åº¦</th><th>é‘‘åˆ¥åº¦</th><th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody id="myBody"></tbody>
    </table>

    <div class="pagination">
        <button id="prevBtn" class="page-btn" onclick="changePage(-1)">â¬…ï¸ ä¸Šä¸€é </button>
        <span id="pageInfo">ç¬¬ 1 / 1 é </span>
        <button id="nextBtn" class="page-btn" onclick="changePage(1)">ä¸‹ä¸€é  â¡ï¸</button>
    </div>

    <script>
        let sheetData = [];       // åŸå§‹å…¨éƒ¨è³‡æ–™ (å« index)
        let filteredData = [];    // æœå°‹å¾Œçš„è³‡æ–™
        let currentPage = 1;      // ç•¶å‰é ç¢¼
        let rowsPerPage = 10;     // æ¯é ç­†æ•¸
        const API_URL = "https://script.google.com/macros/s/AKfycbwZ6H1Ooxf5CztpjT1a6lD_tQ_cPNmHZQgEvXLvUGx6nhMF3lYMHWJHfRViTyxd_xM/exec"; 

        // è¼‰å…¥è³‡æ–™
        async function loadTable() {
            $("#myBody").html('<tr><td colspan="11">âŒ› è³‡æ–™è¼‰å…¥ä¸­...</td></tr>');
            try {
                const response = await fetch(API_URL);
                const rawData = await response.json();
                
                // è½‰æ›è³‡æ–™æ ¼å¼ä¸¦è·³éæ¨™é¡Œåˆ—(i=0)
                sheetData = [];
                for (let i = 1; i < rawData.length; i++) {
                    sheetData.push({ index: i, row: rawData[i] });
                }
                filteredData = [...sheetData];
                renderTable();
            } catch (e) {
                $("#myBody").html('<tr><td colspan="11">âŒ è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– APIã€‚</td></tr>');
            }
        }

        // æ¸²æŸ“è¡¨æ ¼
        function renderTable() {
            const tableBody = $("#myBody");
            tableBody.empty();

            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = startIndex + rowsPerPage;
            const pageData = filteredData.slice(startIndex, endIndex);

            if (pageData.length === 0) {
                tableBody.append('<tr><td colspan="11">æŸ¥ç„¡è³‡æ–™</td></tr>');
            } else {
                pageData.forEach(item => {
                    const r = item.row;
                    const i = item.index;
                    tableBody.append(`<tr>
                        <td>${r[0]||''}</td><td>${r[1]||''}</td><td>${r[2]||''}</td><td>${r[3]||''}</td>
                        <td>${r[4]||''}</td><td>${r[5]||''}</td><td>${r[6]||''}</td><td>${r[7]||''}</td>
                        <td>${r[8]||''}</td><td>${r[9]||''}</td>
                        <td>
                            <button class="edit-btn" onclick="editRow(${i})">âœï¸</button>
                            <button class="delete-btn" onclick="deleteRow(${i})">ğŸ—‘ï¸</button>
                        </td>
                    </tr>`);
                });
            }
            updatePaginationUI();
        }

        // æ›´æ–°åˆ†é  UI
        function updatePaginationUI() {
            const totalPages = Math.ceil(filteredData.length / rowsPerPage) || 1;
            $("#pageInfo").text(`ç¬¬ ${currentPage} / ${totalPages} é  (å…± ${filteredData.length} ç­†)`);
            $("#prevBtn").prop("disabled", currentPage === 1);
            $("#nextBtn").prop("disabled", currentPage === totalPages || filteredData.length === 0);
        }

        function changePage(step) {
            currentPage += step;
            renderTable();
            window.scrollTo(0, 0);
        }

        // æœå°‹èˆ‡é¸å–®ç›£è½
        $(document).ready(function () {
            loadTable();
            $("#myInput").on("input", function () {
                const val = $(this).val().toLowerCase();
                filteredData = sheetData.filter(item => 
                    item.row.some(cell => String(cell).toLowerCase().includes(val))
                );
                currentPage = 1;
                renderTable();
            });
            $("#rowsPerPageSelect").on("change", function() {
                rowsPerPage = parseInt($(this).val());
                currentPage = 1;
                renderTable();
            });
        });

        // åŠŸèƒ½ï¼šæ–°å¢/ä¿®æ”¹/åˆªé™¤
        function addNew() {
            $("#formTitle").text("â• æ–°å¢è³‡æ–™");
            $("#rowIndex").val("");
            $("#dataForm input[type='text']").val("");
            $("#dataForm").show();
        }

        function editRow(originalIndex) {
            const target = sheetData.find(item => item.index === originalIndex);
            if (!target) return;
            const r = target.row;
            $("#formTitle").text("âœï¸ ç·¨è¼¯è³‡æ–™");
            $("#rowIndex").val(originalIndex);
            $("#year").val(r[0]); $("#term").val(r[1]); $("#publisher").val(r[2]);
            $("#question").val(r[3]); $("#unit").val(r[4]); $("#content").val(r[5]);
            $("#answer").val(r[6]); $("#category").val(r[7]); $("#difficult").val(r[8]);
            $("#discrimination").val(r[9]);
            $("#dataForm").show();
        }

        function hideForm() { $("#dataForm").hide(); }

        async function deleteRow(index) {
            if (!confirm("ç¢ºå®šåˆªé™¤ç¬¬ " + index + " åˆ—è³‡æ–™å—ï¼Ÿ")) return;
            const params = new URLSearchParams({ action: "delete", row: index });
            await fetch(API_URL, { method: "POST", body: params });
            loadTable();
        }

        async function saveData() {
            const rowIdx = $("#rowIndex").val();
            const actionType = rowIdx !== "" ? "update" : "add";
            const payload = {
                action: actionType,
                row: rowIdx,
                å¹´åº¦: $("#year").val(), æ¬¡åˆ¥: $("#term").val(), å‡ºç‰ˆç¤¾: $("#publisher").val(),
                é¡Œè™Ÿ: $("#question").val(), å†Šåˆ¥å–®å…ƒ: $("#unit").val(), æ¸¬é©—å…§å®¹: $("#content").val(),
                ç­”æ¡ˆ: $("#answer").val(), é¡åˆ¥: $("#category").val(), é›£åº¦: $("#difficult").val(), é‘‘åˆ¥åº¦: $("#discrimination").val()
            };

            const formData = new URLSearchParams();
            for (let key in payload) formData.append(key, payload[key]);

            $("#saveBtn").prop("disabled", true).text("âŒ› è™•ç†ä¸­...");
            await fetch(API_URL, { method: "POST", body: formData, mode: "no-cors" });
            
            alert("æŒ‡ä»¤å·²é€å‡ºï¼");
            hideForm();
            setTimeout(() => { loadTable(); $("#saveBtn").prop("disabled", false).text("ğŸ’¾ å„²å­˜"); }, 1500);
        }
    </script>
</body>
</html>